{"version":3,"sources":["../src/notifications/webhooks.ts"],"sourcesContent":["/**\n * Webhook Notification System\n *\n * Sends notifications to configured webhook endpoints when\n * pipeline events occur. Supports retries, HMAC signatures,\n * and delivery tracking.\n */\n\nimport { EventEmitter } from \"eventemitter3\";\nimport { createHmac } from \"crypto\";\nimport type { WebhookConfig, WebhookDelivery, WebhookEventType, SupabaseStorage } from \"../storage/supabase.js\";\nimport type { PipelineExecution } from \"../analytics.js\";\nimport type { PipelineResult } from \"../queue/workers.js\";\n\n// =========================================================================\n// TYPES\n// =========================================================================\n\nexport interface WebhookManagerConfig {\n  /** Storage for persisting webhook configs and deliveries */\n  storage?: SupabaseStorage;\n  /** Default retry count (default: 3) */\n  defaultRetries?: number;\n  /** Default timeout in ms (default: 5000) */\n  defaultTimeout?: number;\n  /** Rate limit: max deliveries per minute (default: 60) */\n  rateLimit?: number;\n  /** Enable async delivery (default: true) */\n  asyncDelivery?: boolean;\n}\n\nexport interface WebhookPayload {\n  event: WebhookEventType;\n  timestamp: string;\n  data: Record<string, unknown>;\n}\n\nexport interface DeliveryResult {\n  success: boolean;\n  webhookId: string;\n  statusCode?: number;\n  responseBody?: string;\n  error?: string;\n  attempts: number;\n  duration: number;\n}\n\nexport interface WebhookManagerEvents {\n  \"delivery:success\": (result: DeliveryResult) => void;\n  \"delivery:failed\": (result: DeliveryResult) => void;\n  \"delivery:retrying\": (webhookId: string, attempt: number) => void;\n  \"rateLimit:exceeded\": (webhookId: string) => void;\n}\n\n// =========================================================================\n// WEBHOOK MANAGER\n// =========================================================================\n\nexport class WebhookManager extends EventEmitter<WebhookManagerEvents> {\n  private config: Required<WebhookManagerConfig>;\n  private webhooks: Map<string, WebhookConfig> = new Map();\n  private deliveryQueue: Array<{ webhook: WebhookConfig; payload: WebhookPayload; attempt: number }> = [];\n  private deliveryCountsPerMinute: Map<string, number> = new Map();\n  private isProcessing = false;\n\n  constructor(config: WebhookManagerConfig = {}) {\n    super();\n    this.config = {\n      storage: config.storage || undefined!,\n      defaultRetries: config.defaultRetries || 3,\n      defaultTimeout: config.defaultTimeout || 5000,\n      rateLimit: config.rateLimit || 60,\n      asyncDelivery: config.asyncDelivery !== false,\n    };\n\n    // Reset rate limit counts every minute\n    setInterval(() => {\n      this.deliveryCountsPerMinute.clear();\n    }, 60000);\n  }\n\n  /**\n   * Initialize and load webhooks from storage\n   */\n  async initialize(): Promise<void> {\n    if (this.config.storage?.connected) {\n      try {\n        const webhooks = await this.config.storage.getEnabledWebhooks();\n        for (const webhook of webhooks) {\n          this.webhooks.set(webhook.id, webhook);\n        }\n        console.log(`[Webhooks] Loaded ${webhooks.length} webhook configs`);\n      } catch (error) {\n        console.error(\"[Webhooks] Failed to load webhooks:\", error);\n      }\n    }\n  }\n\n  /**\n   * Register a new webhook\n   */\n  async registerWebhook(\n    config: Omit<WebhookConfig, \"id\" | \"createdAt\" | \"updatedAt\" | \"failureCount\" | \"lastTriggeredAt\" | \"lastStatus\">\n  ): Promise<WebhookConfig> {\n    const webhook: WebhookConfig = {\n      ...config,\n      id: `wh_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`,\n      failureCount: 0,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    };\n\n    this.webhooks.set(webhook.id, webhook);\n\n    // Persist to storage\n    if (this.config.storage?.connected) {\n      try {\n        const saved = await this.config.storage.saveWebhook(config);\n        this.webhooks.set(saved.id, saved);\n        return saved;\n      } catch (error) {\n        console.error(\"[Webhooks] Failed to save webhook:\", error);\n      }\n    }\n\n    return webhook;\n  }\n\n  /**\n   * Update webhook configuration\n   */\n  updateWebhook(id: string, updates: Partial<WebhookConfig>): WebhookConfig | null {\n    const webhook = this.webhooks.get(id);\n    if (!webhook) return null;\n\n    const updated = {\n      ...webhook,\n      ...updates,\n      id: webhook.id,\n      createdAt: webhook.createdAt,\n      updatedAt: new Date(),\n    };\n\n    this.webhooks.set(id, updated);\n    return updated;\n  }\n\n  /**\n   * Remove a webhook\n   */\n  removeWebhook(id: string): boolean {\n    return this.webhooks.delete(id);\n  }\n\n  /**\n   * Get all registered webhooks\n   */\n  getWebhooks(): WebhookConfig[] {\n    return Array.from(this.webhooks.values());\n  }\n\n  /**\n   * Get webhook by ID\n   */\n  getWebhook(id: string): WebhookConfig | undefined {\n    return this.webhooks.get(id);\n  }\n\n  /**\n   * Trigger webhooks for a pipeline event\n   */\n  async triggerPipelineEvent(\n    event: \"pipeline.started\" | \"pipeline.completed\" | \"pipeline.failed\",\n    execution: PipelineExecution | PipelineResult\n  ): Promise<void> {\n    const payload: WebhookPayload = {\n      event,\n      timestamp: new Date().toISOString(),\n      data: {\n        executionId: \"executionId\" in execution ? execution.executionId : execution.id,\n        pipelineId: execution.pipelineId,\n        status: execution.status,\n        ...(\"totalDuration\" in execution && { duration: execution.totalDuration }),\n        ...(\"totalTokens\" in execution && { tokens: execution.totalTokens }),\n        ...(\"completedSteps\" in execution && { completedSteps: execution.completedSteps }),\n        ...(\"failedSteps\" in execution && { failedSteps: execution.failedSteps }),\n        ...(\"cost\" in execution && { cost: execution.cost }),\n        ...(\"error\" in execution && execution.error && { error: execution.error }),\n      },\n    };\n\n    await this.trigger(event, payload);\n  }\n\n  /**\n   * Trigger webhooks for cost threshold alert\n   */\n  async triggerCostAlert(\n    dailyCost: number,\n    threshold: number,\n    details: Record<string, unknown> = {}\n  ): Promise<void> {\n    const payload: WebhookPayload = {\n      event: \"cost.threshold\",\n      timestamp: new Date().toISOString(),\n      data: {\n        dailyCost,\n        threshold,\n        percentOfThreshold: Math.round((dailyCost / threshold) * 100),\n        ...details,\n      },\n    };\n\n    await this.trigger(\"cost.threshold\", payload);\n  }\n\n  /**\n   * Trigger webhooks for daily summary\n   */\n  async triggerDailySummary(summary: Record<string, unknown>): Promise<void> {\n    const payload: WebhookPayload = {\n      event: \"daily.summary\",\n      timestamp: new Date().toISOString(),\n      data: summary,\n    };\n\n    await this.trigger(\"daily.summary\", payload);\n  }\n\n  /**\n   * Trigger all webhooks subscribed to an event\n   */\n  private async trigger(event: WebhookEventType, payload: WebhookPayload): Promise<void> {\n    const subscribedWebhooks = Array.from(this.webhooks.values()).filter(\n      (w) => w.enabled && w.events.includes(event)\n    );\n\n    if (subscribedWebhooks.length === 0) {\n      return;\n    }\n\n    for (const webhook of subscribedWebhooks) {\n      if (this.config.asyncDelivery) {\n        // Add to queue for async processing\n        this.deliveryQueue.push({ webhook, payload, attempt: 1 });\n        this.processQueue();\n      } else {\n        // Deliver synchronously\n        await this.deliver(webhook, payload, 1);\n      }\n    }\n  }\n\n  /**\n   * Process delivery queue\n   */\n  private async processQueue(): Promise<void> {\n    if (this.isProcessing || this.deliveryQueue.length === 0) {\n      return;\n    }\n\n    this.isProcessing = true;\n\n    while (this.deliveryQueue.length > 0) {\n      const item = this.deliveryQueue.shift();\n      if (!item) break;\n\n      // Check rate limit\n      const currentCount = this.deliveryCountsPerMinute.get(item.webhook.id) || 0;\n      if (currentCount >= this.config.rateLimit) {\n        this.emit(\"rateLimit:exceeded\", item.webhook.id);\n        // Re-queue for later\n        this.deliveryQueue.push(item);\n        await new Promise((resolve) => setTimeout(resolve, 1000));\n        continue;\n      }\n\n      // Deliver\n      await this.deliver(item.webhook, item.payload, item.attempt);\n    }\n\n    this.isProcessing = false;\n  }\n\n  /**\n   * Deliver payload to webhook endpoint\n   */\n  private async deliver(\n    webhook: WebhookConfig,\n    payload: WebhookPayload,\n    attempt: number\n  ): Promise<DeliveryResult> {\n    const startTime = Date.now();\n    const body = JSON.stringify(payload);\n    const signature = this.sign(webhook.secret, body);\n\n    // Track rate limit\n    const currentCount = this.deliveryCountsPerMinute.get(webhook.id) || 0;\n    this.deliveryCountsPerMinute.set(webhook.id, currentCount + 1);\n\n    try {\n      const controller = new AbortController();\n      const timeout = setTimeout(() => controller.abort(), webhook.timeoutMs || this.config.defaultTimeout);\n\n      const response = await fetch(webhook.url, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"X-Webhook-Signature\": signature,\n          \"X-Webhook-Event\": payload.event,\n          \"X-Webhook-Timestamp\": payload.timestamp,\n          \"X-Webhook-Delivery\": `${webhook.id}_${Date.now()}`,\n        },\n        body,\n        signal: controller.signal,\n      });\n\n      clearTimeout(timeout);\n\n      const responseBody = await response.text().catch(() => \"\");\n      const duration = Date.now() - startTime;\n\n      const result: DeliveryResult = {\n        success: response.ok,\n        webhookId: webhook.id,\n        statusCode: response.status,\n        responseBody: responseBody.slice(0, 1000), // Limit response size\n        attempts: attempt,\n        duration,\n      };\n\n      // Update webhook stats\n      webhook.lastTriggeredAt = new Date();\n      webhook.lastStatus = response.ok ? \"success\" : `error_${response.status}`;\n      if (!response.ok) {\n        webhook.failureCount++;\n      } else {\n        webhook.failureCount = 0;\n      }\n\n      // Record delivery\n      if (this.config.storage?.connected) {\n        await this.config.storage.recordDelivery({\n          webhookId: webhook.id,\n          eventType: payload.event,\n          payload: payload.data,\n          status: response.ok ? \"delivered\" : \"failed\",\n          attempts: attempt,\n          responseStatus: response.status,\n          responseBody: responseBody.slice(0, 1000),\n          deliveredAt: new Date(),\n        }).catch(() => {});\n      }\n\n      if (response.ok) {\n        this.emit(\"delivery:success\", result);\n      } else {\n        // Retry on failure\n        if (attempt < (webhook.retryCount || this.config.defaultRetries)) {\n          this.emit(\"delivery:retrying\", webhook.id, attempt + 1);\n          // Exponential backoff\n          const delay = Math.pow(2, attempt) * 1000;\n          setTimeout(() => {\n            this.deliveryQueue.push({ webhook, payload, attempt: attempt + 1 });\n            this.processQueue();\n          }, delay);\n        } else {\n          result.error = `Failed after ${attempt} attempts`;\n          this.emit(\"delivery:failed\", result);\n        }\n      }\n\n      return result;\n    } catch (error) {\n      const duration = Date.now() - startTime;\n      const errorMessage = error instanceof Error ? error.message : String(error);\n\n      const result: DeliveryResult = {\n        success: false,\n        webhookId: webhook.id,\n        error: errorMessage,\n        attempts: attempt,\n        duration,\n      };\n\n      // Update webhook stats\n      webhook.lastTriggeredAt = new Date();\n      webhook.lastStatus = `error_${errorMessage.slice(0, 50)}`;\n      webhook.failureCount++;\n\n      // Record delivery failure\n      if (this.config.storage?.connected) {\n        await this.config.storage.recordDelivery({\n          webhookId: webhook.id,\n          eventType: payload.event,\n          payload: payload.data,\n          status: \"failed\",\n          attempts: attempt,\n          error: errorMessage,\n        }).catch(() => {});\n      }\n\n      // Retry on failure\n      if (attempt < (webhook.retryCount || this.config.defaultRetries)) {\n        this.emit(\"delivery:retrying\", webhook.id, attempt + 1);\n        const delay = Math.pow(2, attempt) * 1000;\n        setTimeout(() => {\n          this.deliveryQueue.push({ webhook, payload, attempt: attempt + 1 });\n          this.processQueue();\n        }, delay);\n      } else {\n        this.emit(\"delivery:failed\", result);\n      }\n\n      return result;\n    }\n  }\n\n  /**\n   * Sign payload with HMAC-SHA256\n   */\n  private sign(secret: string, payload: string): string {\n    return `sha256=${createHmac(\"sha256\", secret).update(payload).digest(\"hex\")}`;\n  }\n\n  /**\n   * Verify webhook signature\n   */\n  static verifySignature(secret: string, payload: string, signature: string): boolean {\n    const expected = `sha256=${createHmac(\"sha256\", secret).update(payload).digest(\"hex\")}`;\n    return signature === expected;\n  }\n}\n\n// =========================================================================\n// SINGLETON\n// =========================================================================\n\nlet webhookManagerInstance: WebhookManager | null = null;\n\n/**\n * Get or create webhook manager singleton\n */\nexport function getWebhookManager(config?: WebhookManagerConfig): WebhookManager {\n  if (!webhookManagerInstance) {\n    webhookManagerInstance = new WebhookManager(config);\n  }\n  return webhookManagerInstance;\n}\n\n/**\n * Create webhook manager with storage\n */\nexport async function createWebhookManager(config: WebhookManagerConfig = {}): Promise<WebhookManager> {\n  const manager = getWebhookManager(config);\n  await manager.initialize();\n  return manager;\n}\n"],"mappings":"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","names":[]}