{"version":3,"sources":["../src/audit/audit-logger.ts"],"sourcesContent":["/**\n * Audit Logger for Level 2 Autonomy\n *\n * Logs all autonomy actions with hash chain for integrity:\n * - Action received\n * - Risk assessment\n * - Decision made\n * - Execution results\n * - Approvals/rejections\n */\n\nimport { createHash } from \"crypto\";\nimport type {\n  Action,\n  Decision,\n  AuditEntry,\n  AuditEntryType,\n  ExecutionResult,\n  ApprovalRequest,\n} from \"../core/types.js\";\nimport { AUDIT_CONFIG } from \"../core/constants.js\";\nimport { Logger } from \"../utils/logger.js\";\n\nexport interface AuditLoggerConfig {\n  /** Maximum entries to keep in memory */\n  maxEntries?: number;\n  /** Retention period in days */\n  retentionDays?: number;\n}\n\nexport class AuditLogger {\n  private logger: Logger;\n  private entries: AuditEntry[];\n  private maxEntries: number;\n  private retentionDays: number;\n  private lastHash: string;\n  private entryCount = 0;\n\n  constructor(config: AuditLoggerConfig = {}) {\n    this.logger = new Logger(\"AuditLogger\");\n    this.entries = [];\n    this.maxEntries = config.maxEntries ?? AUDIT_CONFIG.maxEntriesInMemory;\n    this.retentionDays = config.retentionDays ?? AUDIT_CONFIG.retentionDays;\n    this.lastHash = \"\";\n  }\n\n  /**\n   * Log action received\n   */\n  logActionReceived(action: Action): AuditEntry {\n    return this.log(\"action_received\", action.id, undefined, {\n      type: action.type,\n      engine: action.engine,\n      category: action.category,\n      description: action.description,\n      estimatedValue: action.metadata.estimatedValue,\n    });\n  }\n\n  /**\n   * Log risk assessment\n   */\n  logRiskAssessed(action: Action, decision: Decision): AuditEntry {\n    return this.log(\"risk_assessed\", action.id, decision.id, {\n      riskLevel: decision.assessment.level,\n      riskScore: decision.assessment.score,\n      factors: decision.assessment.factors.map((f) => ({\n        name: f.name,\n        value: f.value,\n        exceeded: f.exceeded,\n      })),\n    });\n  }\n\n  /**\n   * Log decision made\n   */\n  logDecisionMade(decision: Decision): AuditEntry {\n    return this.log(\"decision_made\", decision.actionId, decision.id, {\n      outcome: decision.outcome,\n      reason: decision.reason,\n      riskLevel: decision.assessment.level,\n      riskScore: decision.assessment.score,\n    });\n  }\n\n  /**\n   * Log action queued for approval\n   */\n  logQueuedApproval(request: ApprovalRequest): AuditEntry {\n    return this.log(\"queued_approval\", request.decision.actionId, request.decision.id, {\n      requestId: request.id,\n      priority: request.priority,\n      urgency: request.urgency,\n      expiresAt: request.expiresAt,\n    });\n  }\n\n  /**\n   * Log approval granted\n   */\n  logApproved(request: ApprovalRequest): AuditEntry {\n    return this.log(\"approved\", request.decision.actionId, request.decision.id, {\n      requestId: request.id,\n      approvedBy: request.reviewedBy,\n      feedback: request.feedback,\n      waitTime: request.reviewedAt! - request.createdAt,\n    });\n  }\n\n  /**\n   * Log rejection\n   */\n  logRejected(request: ApprovalRequest, reason: string): AuditEntry {\n    return this.log(\"rejected\", request.decision.actionId, request.decision.id, {\n      requestId: request.id,\n      rejectedBy: request.reviewedBy,\n      reason,\n    });\n  }\n\n  /**\n   * Log execution completed\n   */\n  logExecuted(result: ExecutionResult): AuditEntry {\n    return this.log(\"executed\", result.actionId, result.decisionId, {\n      success: result.success,\n      duration: result.duration,\n      output: result.output,\n    });\n  }\n\n  /**\n   * Log execution failed\n   */\n  logExecutionFailed(result: ExecutionResult): AuditEntry {\n    return this.log(\"execution_failed\", result.actionId, result.decisionId, {\n      error: result.error,\n      duration: result.duration,\n      rolledBack: result.rolledBack,\n    });\n  }\n\n  /**\n   * Log rollback\n   */\n  logRolledBack(actionId: string, decisionId: string): AuditEntry {\n    return this.log(\"rolled_back\", actionId, decisionId, {\n      rolledBackAt: Date.now(),\n    });\n  }\n\n  /**\n   * Log boundary violation\n   */\n  logBoundaryViolation(action: Action, violations: string[]): AuditEntry {\n    return this.log(\"boundary_violation\", action.id, undefined, {\n      violations,\n      type: action.type,\n      category: action.category,\n    });\n  }\n\n  /**\n   * Log escalation\n   */\n  logEscalated(request: ApprovalRequest): AuditEntry {\n    return this.log(\"escalated\", request.decision.actionId, request.decision.id, {\n      requestId: request.id,\n      reason: \"Required immediate attention\",\n      riskLevel: request.decision.assessment.level,\n    });\n  }\n\n  /**\n   * Get all entries\n   */\n  getEntries(): AuditEntry[] {\n    return [...this.entries];\n  }\n\n  /**\n   * Get entries by action ID\n   */\n  getByActionId(actionId: string): AuditEntry[] {\n    return this.entries.filter((e) => e.actionId === actionId);\n  }\n\n  /**\n   * Get entries by type\n   */\n  getByType(type: AuditEntryType): AuditEntry[] {\n    return this.entries.filter((e) => e.type === type);\n  }\n\n  /**\n   * Get entries in time range\n   */\n  getByTimeRange(startTime: number, endTime: number): AuditEntry[] {\n    return this.entries.filter(\n      (e) => e.timestamp >= startTime && e.timestamp <= endTime\n    );\n  }\n\n  /**\n   * Verify integrity of audit chain\n   */\n  verifyIntegrity(): { valid: boolean; brokenAt?: number } {\n    let previousHash = \"\";\n\n    for (let i = 0; i < this.entries.length; i++) {\n      const entry = this.entries[i];\n\n      // Check previous hash link\n      if (entry.previousHash !== previousHash) {\n        return { valid: false, brokenAt: i };\n      }\n\n      // Verify entry hash\n      const expectedHash = this.calculateHash(entry);\n      if (entry.hash !== expectedHash) {\n        return { valid: false, brokenAt: i };\n      }\n\n      previousHash = entry.hash;\n    }\n\n    return { valid: true };\n  }\n\n  /**\n   * Get statistics\n   */\n  getStats(): {\n    totalEntries: number;\n    byType: Record<string, number>;\n    oldestEntry: number | null;\n    newestEntry: number | null;\n  } {\n    const byType: Record<string, number> = {};\n\n    for (const entry of this.entries) {\n      byType[entry.type] = (byType[entry.type] ?? 0) + 1;\n    }\n\n    return {\n      totalEntries: this.entries.length,\n      byType,\n      oldestEntry: this.entries.length > 0 ? this.entries[0].timestamp : null,\n      newestEntry:\n        this.entries.length > 0\n          ? this.entries[this.entries.length - 1].timestamp\n          : null,\n    };\n  }\n\n  /**\n   * Clear all entries\n   */\n  clear(): void {\n    this.entries = [];\n    this.lastHash = \"\";\n    this.logger.info(\"Audit log cleared\");\n  }\n\n  /**\n   * Export entries as JSON\n   */\n  export(): string {\n    return JSON.stringify(this.entries, null, 2);\n  }\n\n  // Private methods\n\n  private log(\n    type: AuditEntryType,\n    actionId: string,\n    decisionId: string | undefined,\n    data: Record<string, unknown>\n  ): AuditEntry {\n    this.entryCount++;\n\n    const entry: AuditEntry = {\n      id: `aud_${Date.now()}_${this.entryCount}`,\n      timestamp: Date.now(),\n      type,\n      actionId,\n      decisionId,\n      data,\n      hash: \"\",\n      previousHash: this.lastHash,\n    };\n\n    entry.hash = this.calculateHash(entry);\n    this.lastHash = entry.hash;\n\n    this.entries.push(entry);\n\n    // Cleanup old entries\n    this.cleanup();\n\n    this.logger.debug(`Audit: ${type}`, { actionId, decisionId });\n\n    return entry;\n  }\n\n  private calculateHash(entry: AuditEntry): string {\n    const content = JSON.stringify({\n      id: entry.id,\n      timestamp: entry.timestamp,\n      type: entry.type,\n      actionId: entry.actionId,\n      decisionId: entry.decisionId,\n      data: entry.data,\n      previousHash: entry.previousHash,\n    });\n\n    return createHash(AUDIT_CONFIG.hashAlgorithm).update(content).digest(\"hex\");\n  }\n\n  private cleanup(): void {\n    // Remove old entries\n    const cutoffTime =\n      Date.now() - this.retentionDays * 24 * 60 * 60 * 1000;\n    this.entries = this.entries.filter((e) => e.timestamp >= cutoffTime);\n\n    // Enforce max entries\n    if (this.entries.length > this.maxEntries) {\n      this.entries = this.entries.slice(-this.maxEntries);\n    }\n  }\n}\n"],"mappings":"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","names":[]}